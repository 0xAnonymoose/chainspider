<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <title>ChainSpider Mobile</title>
  </head>
  <body>

    <!-- Main -->
    <main class="container">
      <article class="grid">
        <div>
    
          <section id="form">
            <hgroup>
              <h1><img src="../icons/spiderweb.png?height=32">&nbsp;ChainSpider Mobile&nbsp;<sup>20220719</sup></h1>
            </hgroup>
          

              <input type="search" id="addr" name="addr" placeholder="BSC Contract Address">
              <button class="outline" onClick='document.onStartClick()'>Scan</button>
 
          </section>

          <section id="progress">
          </section>

      <section id="accordions">
        Enter a contract address above and tap Scan to start.
      </section>

      </article>
    
    </main>
    
    <script type="module">
      import { ChainSpider, Relation } from '../chainspider.mjs';
      import { registerModules } from '../modules.mjs';
      
      class ChainSpiderMobile extends ChainSpider {
      
        constructor() {
            super();
            
            this.active = {};
        }
        
        onSubscriptionStart(sub, relation, id) {
            this.active[id] = {sub, relation};
            this.updateProgress();
        }
        
        onSubscriptionEnd(sub, relation, id) {
            delete this.active[id];
            console.log(this.active);
            this.updateProgress();
        }
        
        updateProgress() {
            let running = Object.keys(this.active);
            let s = '';
            
            if (running.length > 0) {
              s = '<progress id="progress-2"></progress>';
            }
            
            for (let id of running) {
              s += '<button class="secondary outline">'+this.active[id].sub.toString()+' '+this.active[id].relation.src_node.toString()+'</button>';
            }
            
            document.getElementById('progress').innerHTML = s;
        }
        
        onMessage(msg) {
	    super.onMessage(msg);
	    
	    let contextAddr = document.getElementById('addr').value;
	    let s = '';
	    let o = '';
	    let score = 0;
	    let nodes = {};
	    
	    for (let node of this.nodes) {
	      if (node.type == "TokenBEP20") {
	        nodes[node._id] = { "summary": `Token ${node.val.name} (${node.val.symbol})`, "messages": [this.panels["TokenBEP20"](node)] };
	      }
	      if (node.type == "TokenAMM") {
	        nodes[node._id] = { "summary": `${node.val.name}`, "messages": [this.panels["TokenAMM"](node)] };
	      }
	      if (node.type == "WhitelistedToken") {
	        nodes[node._id] = { "summary": `CoinMarketCap`, "messages": [this.panels["WhitelistedToken"](node)] };	      
	      }
	      if (node.type == "MalwareReport") {
	        nodes[node._id] = { "summary": `Malware Scan`, "messages": [this.panels["MalwareReport"](node)] };	      
	      }	      
	    }
	    
	    for (let msg of this.messages) {
	  
	      if (msg.topic != contextAddr) { continue; }
	      
	      let n = msg.node;
	    
	      let color = 'black';
	      if (msg.score < 0) { color = 'red'; }
	      if (msg.score > 0) { color = 'green'; }
	    
	      s = '<p style="color: '+color+'"> '+msg.msg;
	      //o += s;
	      console.log(nodes[n._id]);
	      if (nodes[n._id] !== undefined) { nodes[n._id].messages.push(s); } else { o += s; }
	    
	      score += msg.score;
	    }
	    
	    s='';
	    for (let idx of Object.keys(nodes)) {
	      let n = nodes[idx];
	      s += '<details open><summary>'+n.summary+'</summary>'+n.messages.join('')+'</details>'
	      console.log(s);
	    }
	    
	    let scolor = 'purple';
	    let snote = 'WARNING';
	    if (score <= -100) { snote='SCAM'; scolor='red'; }
	    if (score >= 100) { snote='PASS'; scolor='green'; }
	    let n = '<h1 style="color: '+scolor+'; text-align:center">Score '+score+" "+snote+'</h1>'
	    
	    document.getElementById('accordions').innerHTML = o+n+s;
	  }
  
      }
      
      function onStartClick(e) {
	  let addr = document.getElementById('addr').value;
	  addr = addr.toLowerCase();
	  document.getElementById('addr').value = addr;
	  
          var cs = window.cs = new ChainSpiderMobile();
          registerModules(cs);  
	  cs.createNode('BlockchainAddress', addr);
      }
      document.onStartClick = onStartClick;
	
	const params = new URLSearchParams(window.location.search);
        const addr = params.get("addr");
        if (addr) {
          document.getElementById('addr').value = addr;
          document.onStartClick();
        }
        
    </script>
  </body>
</html>
